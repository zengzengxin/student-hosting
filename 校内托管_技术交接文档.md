---
title: 校内托管_技术交接文档

tags: 该项目一期，需开发的功能，已全部完成，目前等待客户验收完成。
      主流程是课程和托管，以及相应的下单并支付。点餐模块这期不开发。
      共有三个端：管理后台cms、公众号web、小程序mini

---

- 交接人： 黄隆鹏、曾增鑫
- 接收人 ：范房清

- 负责项目：
  - 名称：校内课后托管服务（全称）
  - 相关负责人：
    - 后台：黄隆鹏、曾增鑫
    - 前端：张敏、秦泽森、李成文(cms)
    - 产品：陈心
    - 商务：陈文广
  - 所有模块：
      - 可详看三个端的swagger页面，包括cms端、mini端、web端，地址见交接文件`校内托管相关账号及网址`

- 工作进展：
  - 学生托管一期，需开发的模块，已全部完成，且完成自测及产品测试，正在等待客户验收（客户验收效率较低）

- 模块说明：
  - 课程模块：
    课程与课程套餐是一对多的关系，即一个课程对应多个套餐。
    保存课程时，涉及到的表有课程表，课程套餐表，图片表（专门有一个图片表来保存各种课程/托管/餐品 的图片）。
    修改课程有注意点：ROOT修改不需要下架 学校修改则下架该课程。并且需要同步推荐表的数据。
    mini端需要获取该教师在某个时间段内的所有课程，稍微复杂一点，用sql语句查出数据后，因为前端需要进行日历形式显示,
    后台要将数据处理封装days字段，对日期处理成如`2019-01-01`。详情看mini端的`CourseController`

  - 托管模块
    托管是这个系统的重要功能，托管课程由后台创建，管理后台有上下架和是否推荐的功能，相当于一个商品。
    又与图片表相关，在做修改的收也要修改图片表，购买托管课程的时候需要校验时间是否合格，
    孩子是否为该家长的孩子等，计算价格是按照家长算择的日期，计算上课天数，然后计算价格
    实现难点
    计算上课天数，前端传入两个时间戳，然后计算除去周六周日后有几天，使用了比较安全的遍历来做，
    详情看代码web端的`OrderController`的`countMoney()`

  - 管理员模块、学校模块
    学校模块主要是CRUD以及对学校的excel导入学校。学校角色的管理员需要绑定学校。

  - 老师模块
    老师是教师小程序端的主要用户，它的数据由excel导入，在小程序端当教师授权登录后需要通过电话号码去绑定excel导入的数据，
    证明它是一个老师，然后才可以进行后续操作。

  - 家长模块、孩子模块：
      家长是这个系统的用户，它与孩子模块息息相关，家长的数据来自于微信授权登录，孩子则是这个系统的操作对象。
      - 具体实现流程：
          首先平台管理员会导入孩子，家长访问页面进行授权，家长填写信息和电话号码，
          然后家长需要通过孩子的学号、姓名、所在学校绑定至少一个孩子才能进行很多相关的操作，
          然后购买课程的时候只能为孩子购买孩子所在学校的课程	

  - 轮播图模块、机构模块、公告模块等其他模块都较为常规。

  - 总共需要导入三种Excel表：学校表、教师表、学生表，模板详见交接文件夹`excel表模板`
      注意点：需先导入学校，教师和学生都是依托于学校而存在的。导入了学校才有学校ID，才可确定教师和学生属于哪个学校。


- 其他注意点：
    1. cms项目与web项目都有定时任务，于`com.luwei.timer`包中的定时任务类
    2. web项目一启动就运行`StartService`的run方法，调用`TokenTimerTask`获取一次token和ticket，
       此token和ticket是微信支付模块需要使用到的
    3. 微信支付模块使用公司的模块化，实现了`notify()`方法，详见`OrderService`的`notify()`
    4. 小程序授权登录，公司暂时没有模块化，使用自己写的工具类`WeiXinUtils`. 
       小程序授权接口在mini项目的`WeChatController`
    5. 管理后台区分三个角色：平台(即超级管理员)、教育局、学校。
       每个角色细致的功能区分查看图片`管理后台区分角色细则.png`
    
- 相关文件资料：
  - 见《学生托管_交接文件_2019-01-14》
